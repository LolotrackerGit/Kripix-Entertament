<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurazione - Kripix</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700;900&family=Courier+Prime&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Specifico Settings */
        .settings-grid { display: grid; grid-template-columns: 250px 1fr; gap: 40px; margin-top: 30px; }

        /* Sidebar */
        .settings-nav button {
            display: block; width: 100%; text-align: left;
            background: transparent; border: none;
            color: #888; padding: 15px; font-family: 'Courier Prime'; cursor: pointer;
            border-left: 2px solid transparent; transition: 0.3s;
        }
        .settings-nav button:hover, .settings-nav button.active {
            color: var(--accent-gold); background: rgba(227, 198, 108, 0.05); border-left-color: var(--accent-gold);
        }

        /* Pannello */
        .settings-panel { background: rgba(255,255,255,0.02); border: 1px solid #333; padding: 30px; }
        .panel-title { font-size: 1.5rem; color: #fff; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .setting-row { margin-bottom: 30px; }
        .setting-label { display: block; color: var(--accent-gold); font-size: 0.8rem; margin-bottom: 10px; font-family: 'Courier Prime'; }
        .setting-value { font-size: 1.1rem; color: #fff; }

        /* Color Picker */
        .color-options { display: flex; gap: 15px; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-btn:hover, .color-btn.selected { transform: scale(1.2); border-color: white; }

        /* Toggles */
        .switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 10px 0; border-bottom: 1px solid #222; }
        .switch-text { color: #ccc; }
        .toggle { position: relative; width: 50px; height: 26px; background: #333; border-radius: 20px; transition: 0.3s; }
        .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; }
        input[type="checkbox"]:checked + .toggle { background: var(--accent-gold); }
        input[type="checkbox"]:checked + .toggle::after { transform: translateX(24px); }

        /* Danger Zone */
        .danger-zone { border: 1px solid #8b2323; padding: 20px; background: rgba(139, 35, 35, 0.05); }
        .danger-text { color: #ff5555; font-size: 0.9rem; margin-bottom: 15px; }
        
        .btn-danger {
            display: inline-block; padding: 15px 30px;
            border: 1px solid #8b2323; color: #ff5555;
            background: transparent; font-weight: bold; cursor: pointer; transition: 0.3s;
            font-family: 'Montserrat'; text-transform: uppercase;
        }
        .btn-danger:hover { background: #8b2323; color: white; box-shadow: 0 0 15px rgba(139, 35, 35, 0.5); }

        /* Stile Input nei Modali */
        .modal-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: #000; border: 1px solid #333; color: white;
            font-family: 'Montserrat'; font-size: 1rem;
        }
        .modal-input:focus { outline: none; border-color: var(--accent-gold); }
        
        /* Errore Input */
        .error-border { border-color: red !important; animation: shake 0.3s; }
        .error-msg { color: red; font-size: 0.8rem; margin-bottom: 15px; display: none; font-family: 'Courier Prime'; }
        
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        @media(max-width:768px) { .settings-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="background-grid"></div>

    <nav>
        <div class="logo-text"><a href="index.html">KRIPIX</a></div>
        <div class="hamburger"><span></span><span></span><span></span></div>
        <ul class="nav-links nav-menu">
            <li><a href="progetti.html">Progetti</a></li>
            <li><a href="studio.html">Chi Siamo</a></li>
            <li><a href="contatti.html">Contatti</a></li>
            <li><a href="download.html" class="btn-launcher">Scarica App</a></li>
        </ul>
    </nav>

    <div class="page-header">
        <h1>CONFIGURAZIONE</h1>
    </div>

    <section class="section-padding">
        <div class="container settings-grid">
            <div class="settings-nav">
                <button class="active">PROFILO AGENTE</button>
                <button onclick="alert('Presto disponibile')">PRIVACY</button>
            </div>

            <div class="settings-panel">
                <h3 class="panel-title">IDENTITÀ AGENTE</h3>

                <div class="setting-row">
                    <span class="setting-label">NOME IN CODICE</span>
                    <div class="setting-value" id="disp-user">Caricamento...</div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">EMAIL REGISTRATA</span>
                    <div class="setting-value" id="disp-email" style="opacity: 0.7;">recupero dati...</div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">SEGNALE CROMATICO</span>
                    <div class="color-options">
                        <div class="color-btn" style="background:#e3c66c" onclick="changeColor('#e3c66c')"></div>
                        <div class="color-btn" style="background:#8b2323" onclick="changeColor('#8b2323')"></div>
                        <div class="color-btn" style="background:#2a475e" onclick="changeColor('#2a475e')"></div>
                        <div class="color-btn" style="background:#4caf50" onclick="changeColor('#4caf50')"></div>
                        <div class="color-btn" style="background:#9c27b0" onclick="changeColor('#9c27b0')"></div>
                    </div>
                </div>

                <h3 class="panel-title" style="margin-top: 50px;">SICUREZZA</h3>
                
                <div class="setting-row">
                    <span class="setting-label">CODICE D'ACCESSO</span>
                    <button class="btn-outline" onclick="openPassModal()">MODIFICA PASSWORD</button>
                </div>

                <div class="setting-row danger-zone">
                    <span class="setting-label" style="color:#ff5555;">ZONA ROSSA</span>
                    <p class="danger-text">L'eliminazione è irreversibile. Tutte le licenze verranno revocate.</p>
                    <button class="btn-danger" onclick="openDeleteModal()">ELIMINA ACCOUNT</button>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALE 1: CAMBIO PASSWORD -->
    <div id="pass-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px;">
            <h3 style="color:var(--accent-gold); margin-bottom:20px;">AGGIORNA CREDENZIALI</h3>
            
            <input type="password" id="old-pass" class="modal-input" placeholder="Vecchia Password">
            
            <input type="password" id="new-pass" class="modal-input" placeholder="Nuova Password (Min 8 + Num)">
            
            <input type="password" id="conf-pass" class="modal-input" placeholder="Conferma Nuova Password">
            
            <p id="pass-msg" class="error-msg">ERRORE</p>

            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-outline" onclick="closePassModal()">ANNULLA</button>
                <button class="btn-gold" onclick="confirmPassChange()">AGGIORNA</button>
            </div>
        </div>
    </div>

    <!-- MODALE 2: Successo -->
    <div id="success-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; border-top-color:#4caf50;">
            <h3 style="color:#4caf50; margin-bottom:15px;">OPERAZIONE RIUSCITA</h3>
            <p style="color:#ccc;">Le credenziali sono state aggiornate nel sistema.</p>
            <button class="btn-outline" style="margin-top:20px;" onclick="location.reload()">CHIUDI</button>
        </div>
    </div>

    <!-- MODALE 3: Richiesta Password per Eliminazione -->
    <div id="delete-modal" class="modal-overlay" style="display:none; background:rgba(20,0,0,0.9);">
        <div class="modal-box" style="border-top-color:#ff5555; max-width:400px;">
            <h3 style="color:#ff5555; margin-bottom:15px; font-size:1.5rem;">⚠ CONFERMA ELIMINAZIONE</h3>
            <p style="font-size:0.9rem; color:#ccc; margin-bottom:20px;">
                Per confermare, inserisci la tua password attuale.
            </p>
            <input type="password" id="del-password" class="modal-input" placeholder="Password attuale">
            <p id="del-error" class="error-msg">PASSWORD ERRATA</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn-outline" onclick="closeDeleteModal()">ANNULLA</button>
                <button class="btn-danger" onclick="confirmDelete()">CONFERMA</button>
            </div>
        </div>
    </div>

    <!-- MODALE 4: Addio -->
    <div id="goodbye-modal" class="modal-overlay">
        <div class="modal-box" style="border-top-color:#ccc; max-width:400px;">
            <h3 style="color:#fff; margin-bottom:15px;">PROTOCOLLO COMPLETATO</h3>
            <p style="color:#888;">ID Agente rimosso dal database.</p>
            <p style="color:#888; font-family:'Courier Prime'; margin-top:10px;">Disconnessione in corso...</p>
        </div>
    </div>

    <footer><p>&copy; 2026 Kripix Entertainment.</p></footer>
    <script src="script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('kripix_user');
            if (!currentUser) { window.location.href = 'login.html'; return; }
            document.getElementById('disp-user').innerText = currentUser;
            document.getElementById('del-username') ? document.getElementById('del-username').innerText = currentUser : null;

            const db = JSON.parse(localStorage.getItem('kripix_database')) || [];
            const userData = db.find(u => u.username === currentUser);
            if(userData) document.getElementById('disp-email').innerText = userData.email;
        });

        function changeColor(newColor) {
            localStorage.setItem('kripix_color', newColor);
            const currentUser = localStorage.getItem('kripix_user');
            let db = JSON.parse(localStorage.getItem('kripix_database')) || [];
            const userIndex = db.findIndex(u => u.username === currentUser);
            if(userIndex !== -1) {
                db[userIndex].color = newColor;
                localStorage.setItem('kripix_database', JSON.stringify(db));
            }
            const navAvatar = document.querySelector('.user-avatar');
            if(navAvatar) navAvatar.style.backgroundColor = newColor;
        }

        // --- CAMBIO PASSWORD ---
        function openPassModal() {
            document.getElementById('pass-modal').style.display = 'flex';
            // Pulisci campi
            document.getElementById('old-pass').value = '';
            document.getElementById('new-pass').value = '';
            document.getElementById('conf-pass').value = '';
            document.getElementById('pass-msg').style.display = 'none';
        }

        function closePassModal() { document.getElementById('pass-modal').style.display = 'none'; }

        function confirmPassChange() {
            const oldPass = document.getElementById('old-pass');
            const newPass = document.getElementById('new-pass');
            const confPass = document.getElementById('conf-pass');
            const msg = document.getElementById('pass-msg');

            const currentUser = localStorage.getItem('kripix_user');
            let db = JSON.parse(localStorage.getItem('kripix_database')) || [];
            const userIndex = db.findIndex(u => u.username === currentUser);
            const userData = db[userIndex];

            // 1. Verifica Vecchia Password
            if (userData.password !== oldPass.value) {
                showError(oldPass, msg, "VECCHIA PASSWORD ERRATA");
                return;
            }

            // 2. Verifica Nuova Password (Min 8 + Num)
            if (newPass.value.length < 8 || !/\d/.test(newPass.value)) {
                showError(newPass, msg, "NUOVA PASSWORD TROPPO DEBOLE (MIN 8 + NUM)");
                return;
            }

            // 3. Verifica Match
            if (newPass.value !== confPass.value) {
                showError(confPass, msg, "LE NUOVE PASSWORD NON COINCIDONO");
                return;
            }

            // SUCCESSO!
            // Aggiorna DB
            db[userIndex].password = newPass.value;
            localStorage.setItem('kripix_database', JSON.stringify(db));

            closePassModal();
            document.getElementById('success-modal').style.display = 'flex';
        }

        function showError(input, msgEl, text) {
            input.classList.add('error-border');
            msgEl.innerText = text;
            msgEl.style.display = 'block';
            setTimeout(() => input.classList.remove('error-border'), 500);
        }

        // --- GESTIONE ELIMINAZIONE ---
        function openDeleteModal() {
            document.getElementById('delete-modal').style.display = 'flex';
            document.getElementById('del-password').value = '';
            document.getElementById('del-error').style.display = 'none';
        }
        function closeDeleteModal() { document.getElementById('delete-modal').style.display = 'none'; }
        
        function confirmDelete() {
            const inputPass = document.getElementById('del-password').value;
            const currentUser = localStorage.getItem('kripix_user');
            
            let db = JSON.parse(localStorage.getItem('kripix_database')) || [];
            const userData = db.find(u => u.username === currentUser);

            if (userData && userData.password === inputPass) {
                const newDB = db.filter(u => u.username !== currentUser);
                localStorage.setItem('kripix_database', JSON.stringify(newDB));
                localStorage.removeItem('kripix_user');
                localStorage.removeItem('kripix_color');
                localStorage.removeItem('owned_game_harrow');
                closeDeleteModal();
                document.getElementById('goodbye-modal').style.display = 'flex';
                setTimeout(() => { window.location.href = 'index.html'; }, 2500);
            } else {
                const inputEl = document.getElementById('del-password');
                inputEl.classList.add('error-border');
                document.getElementById('del-error').style.display = 'block';
                setTimeout(() => inputEl.classList.remove('error-border'), 500);
            }
        }
    </script>
</body>
</html>